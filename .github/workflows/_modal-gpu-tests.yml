name: Modal GPU Tests (reusable)

on:
  workflow_call:
    inputs:
      ref:
        required: false
        type: string
        default: ""
      gpu:
        description: "GPU type (L4, T4, A10G, A100, H100â€¦)"
        required: false
        type: string
        default: "L4"
      python-version:
        description: "Python version for uv setup"
        required: false
        type: string
        default: "3.10"
      test-path:
        description: "Path passed to --test-path"
        required: false
        type: string
        default: "tests/"
      pytest-args:
        description: "Args passed to --pytest-args"
        required: false
        type: string
        default: "-v"
    secrets:
      MODAL_TOKEN_ID:
        required: true
      MODAL_TOKEN_SECRET:
        required: true

jobs:
  gpu-tests:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: ğŸ Install uv and set Python
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          python-version: ${{ inputs.python-version }}
          activate-environment: true

      - name: ğŸš€ Install Packages
        run: |
          uv pip install -e . --group tests


      - name: ğŸ® Run Modal GPU tests
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          MODAL_GPU: ${{ inputs.gpu }}
        run: |
          modal run .modal/test_runner.py --test-path "${{ inputs.test-path }}" --pytest-args "${{ inputs.pytest-args }}"

      - name: ğŸ“¤ Upload pytest output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-output
          path: test-outputs/pytest-output.log
          if-no-files-found: warn
          retention-days: 30
